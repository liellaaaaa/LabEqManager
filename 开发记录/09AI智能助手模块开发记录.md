# AI 智能助手模块开发记录（ai-assistant）

## 开发目标

在现有“高校实验室设备管理系统”基础上，新增一个 **轻量级、单轮对话** 的 AI 智能助手模块，主要满足：

- 为学生 / 教师 / 管理员提供自然语言咨询与指引；
- 严格限制大模型权限：只做说明与引导，不做任何真实的数据操作；
- 支持 **本地知识库优先**，通义千问（DashScope）作为兜底；
- 对每次对话进行结构化日志记录，便于审计与后续优化。

## 后端实现概要

### 1. 实体与表设计

- 实体：`AiChatLog`
  - `id`：主键，自增
  - `userId`：用户 ID（关联 `user.id`）
  - `userInput`：用户输入内容（TEXT）
  - `aiOutput`：AI 输出内容（TEXT）
  - `source`：回答来源（`knowledge` / `api`）
  - `logDate`：日志日期（按自然日分表/分区用）
  - `createTime`：创建时间
  - `@PrePersist` 自动填充 `logDate` 和 `createTime`

对应表：`ai_chat_log`，并创建索引：

- `idx_user_date (user_id, log_date)`
- `idx_log_date (log_date)`

### 2. DashScope 配置与服务

- 配置类：`DashScopeConfig`
  - `dashscope.apiKey`：从 `application.yml` 配置
  - `dashscope.model`：默认 `qwen-turbo`

- 服务类：`AiAssistantService`
  - 特性：
    - **单轮对话**：`chat(ChatRequest)` 每次仅基于当前 `message` 生成回答，不维护上下文；
    - 知识库优先：
      - `matchKnowledgeBase()`：先在内置 `Map<String, String>` 中做完全匹配 / 包含匹配 / 关键词匹配；
      - 命中则直接返回，`source = "knowledge"`，不调用大模型；
    - 大模型兜底：
      - 使用 `Generation` + `QwenParam` 调用 DashScope；
      - 通过统一的系统提示词 `buildPrompt(userInput)` 明确限制：
        - 只回答与本系统相关的问题；
        - 禁止生成/修改业务数据，禁止 SQL / 接口调用；
        - 对无关/违规问题礼貌拒绝；
      - 使用 **反射** 解析返回结果（兼容 SDK 版本差异），提取首条 `content`；
    - 日志记录：
      - `saveChatLog(userId, userInput, aiOutput, source)`：
        - 所有对话（知识库 / API）均写入 `ai_chat_log`；
        - 日志保存失败仅记录错误日志，不影响主流程。

### 3. 控制层与接口

- 控制器：`AiAssistantController`
  - 路由前缀：`/api/v1/ai`
  - 接口：
    - `POST /api/v1/ai/chat`
      - 请求体：`ChatRequest { message: string }`
      - 响应体：`ApiResponse<ChatResponse> { answer, source }`
      - 权限：`@PreAuthorize("hasAnyRole('admin','teacher','student')")`
      - 安全性：不暴露任何内部实现细节，只返回文本回答和来源标记。

## 前端实现概要

### 1. API 封装

文件：`frontend/src/api/ai.ts`

- `AiChatRequest { message: string }`
- `AiChatResponse { answer: string; source: 'knowledge' | 'api' | string }`
- `chatWithAi(message: string): Promise<ApiResponse<AiChatResponse>>`
  - 调用路径：`POST /ai/chat`
  - 统一使用 `utils/request.ts` 封装的 Axios 实例，自动带上 JWT。

### 2. AI 助手页面（单轮对话）

文件：`frontend/src/views/AiAssistantView.vue`

- 布局：
  - 左侧：问题输入区域
    - `el-input type="textarea"` 输入问题（限制长度、显示字数）；
    - “清空”“发送”按钮；
    - 使用说明 `el-alert`：
      - 不执行真实数据操作；
      - 不生成 SQL / 不调用内部接口；
      - 对无关话题进行限制；
  - 右侧：AI 回答区域
    - 显示 `answer` 文本；
    - 显示来源标签 `source`：
      - `knowledge` → 绿色标签 “知识库”；
      - `api` → 橙色标签 “通义千问”；
    - 支持加载中状态与空态提示。

- 交互逻辑：
  - 每次点击“发送”：
    - 如果输入为空，提示“请输入要咨询的问题”；
    - 调用 `chatWithAi(message)`，将返回内容展示在右侧；
    - 不保留历史对话，仅展示当前轮问题与回答（符合“单轮对话”的约束）。

### 3. 路由与菜单集成

- 路由配置：`frontend/src/router/index.ts`
  - 新增子路由：
    - `path: '/ai'`
    - `name: 'aiAssistant'`
    - `component: () => import('../views/AiAssistantView.vue')`
    - `meta: { requiresAuth: true }`

- 导航菜单：`frontend/src/views/HomeView.vue`
  - 在左侧菜单新增项：
    - 文本：`AI 智能助手`
    - 路径：`/ai`
    - 所有登录用户可见（学生/教师/管理员）。

## 测试与问题汇总

### 1. 后端测试

文件：`backend/src/test/java/org/cong/backend/ai/AiAssistantControllerTest.java`

覆盖场景：

1. 知识库完全匹配（如何借用设备）
2. 知识库包含匹配 / 关键词匹配（设备借用流程、实验室预约等）
3. 知识库未命中 → 调用 DashScope API 兜底
4. 参数校验（空消息 / null 消息）
5. 权限测试（未登录用户访问返回 403）
6. 日志记录（按自然日、按 userId 查询）
7. 单轮对话（两次独立请求、分别落库）

详细问题与修复过程见：`测试记录/09问题汇总.md`。

### 2. 前端联调

简单通过浏览器验证：

- 登录后进入左侧菜单“AI 智能助手”；
- 输入典型问题：
  - “如何借用设备？” → 来源为 `knowledge`，回答为知识库固定文案；
  - “今天天气怎么样？” → 来源为 `api`（若配置了 DashScope API Key），或返回兜底错误提示；
  - 与系统无关的问题（如娱乐/生活类）→ 由后端提示词控制，给予礼貌拒绝或引导。

## 后续优化建议

1. **知识库扩展**
   - 将当前内置 `Map` 迁移到可维护的数据源（DB / 配置文件）；
   - 支持简单的后台管理界面，维护 QA 对。

2. **向量检索 / 语义搜索（可选）**
   - 后续可接入语义检索（向量数据库），提升知识库召回效果；
   - 但仍需保留“知识库优先”的规则与权限边界。

3. **前端体验优化**
   - 可以增加“历史记录（仅前端缓存）”区域，展示本次会话内的若干轮问答；
   - 提供常见问题快捷入口（FAQ 按钮）。

4. **安全与审计**
   - 对敏感操作指引增加固定模板回答，进一步降低误导风险；
   - 后续可以增加对 AI 日志的后台查询与统计页面（结合现有统计模块）。

## 总结

AI 智能助手模块目前已实现：

1. ✅ 单轮对话（不维护上下文）；
2. ✅ 知识库优先 + 通义千问兜底；
3. ✅ 严格限制大模型能力范围（仅咨询/解释/指引）；
4. ✅ 每条对话完整日志记录（按自然日、按用户维度可查询）；
5. ✅ 与前端实验室管理系统无缝集成，支持基于角色的访问控制。

整体实现遵循“轻量、安全、可控”的原则，为后续扩展更复杂 AI 能力（多轮对话、语义检索等）打下基础。


