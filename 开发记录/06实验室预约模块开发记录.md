# 实验室预约模块开发记录（laboratory_reservation）

## 开发目标

实现功能清单中“实验室场地管理”的核心功能：**实验室预约流程（预约申请-冲突检测-审批-完成）**，形成一个基于真实实验室数据的可用闭环。

参考文档：

- 接口文档：`docs/api-docs/reservation.md`
- 数据库结构：`lab_equipment_manager.sql` 中的 `laboratory_reservation` 表

## 数据库设计（回顾）

### 实验室预约记录表 `laboratory_reservation`

- **核心字段**
  - `id`：预约记录 ID
  - `laboratory_id`：实验室 ID（外键，关联 `laboratory.id`）
  - `user_id`：预约人 ID（外键，关联 `user.id`）
  - `reserve_date`：预约日期（DATE）
  - `start_time`：开始时间（TIME）
  - `end_time`：结束时间（TIME）
  - `purpose`：预约目的
  - `status`：状态（0-待审批，1-已通过，2-已拒绝，3-已取消，4-已完成，5-已使用）
  - `approver_id`：审批人 ID
  - `approve_time`：审批时间
  - `approve_remark`：审批备注
  - `actual_start_time`：实际开始时间（TIME）
  - `actual_end_time`：实际结束时间（TIME）
  - `usage_remark`：使用备注
  - `create_time` / `update_time`：创建 / 更新时间

## 后端实现

### 1. 实体 & 仓储

- **实体**
  - `backend/src/main/java/org/cong/backend/reservation/entity/LaboratoryReservation.java`
    - 与 `laboratory_reservation` 表一一对应，使用 JPA 映射 + `@PrePersist` / `@PreUpdate` 自动维护时间字段。
    - 使用 `LocalDate` 表示预约日期，`LocalTime` 表示时间段。

- **仓储**
  - `backend/src/main/java/org/cong/backend/reservation/repository/LaboratoryReservationRepository.java`
    - `List<LaboratoryReservation> findConflictingReservations(...)`：查找指定实验室在指定日期和时间段内已通过或已使用的预约记录（用于冲突检测）。
      - 冲突判断逻辑：新预约的开始时间 < 已有预约的结束时间 AND 新预约的结束时间 > 已有预约的开始时间
      - 支持 `excludeId` 参数，用于更新预约时排除自身
    - `List<LaboratoryReservation> findByLaboratoryIdAndReserveDateAndApprovedStatus(...)`：查找指定实验室在指定日期的所有已通过或已使用的预约记录（用于计算可用时间段）。

### 2. DTO & 状态常量

- `ReservationStatus`：封装状态值及中文名称映射（0-5），与数据库枚举语义保持一致。
- 请求 DTO：
  - `CreateReservationRequest`：提交预约申请
  - `ApproveReservationRequest`：审批预约申请（仅管理员）
  - `CancelReservationRequest`：取消预约（学生/管理员）
  - `CompleteReservationRequest`：标记预约完成（仅管理员）
  - `CheckConflictRequest`：检查时间冲突
- 响应 DTO：
  - `ReservationListResponse`：预约记录列表项（包含实验室名、预约人姓名、审批人姓名、状态名称等）
  - `ReservationDetailResponse`：预约记录详情
  - `CheckConflictResponse`：冲突检测结果（包含冲突列表）
  - `AvailableTimeResponse`：可用时间段列表
  - `AvailableTimeSlot`：单个可用时间段
  - `ConflictInfo`：冲突信息

### 3. Service 业务逻辑

实现类：`backend/src/main/java/org/cong/backend/reservation/service/LaboratoryReservationService.java`

- **依赖**
  - `LaboratoryReservationRepository`：预约记录持久化
  - `LaboratoryRepository`：实验室信息
  - `UserRepository`：预约人 / 审批人信息
  - `SecurityUtils`：获取当前登录用户及角色

- **核心方法**

1. **getReservationList**：预约记录列表查询
   - 支持分页、按实验室 / 用户 / 预约日期 / 状态过滤、排序。
   - 权限规则：
     - 管理员：可通过 `userId` 参数查看任意用户记录。
     - 教师 / 学生：强制仅能查看自己的预约记录（忽略外部传入的 `userId`）。

2. **getReservationDetail**：预约记录详情
   - 管理员可查看全部；非管理员只能查看自己的记录，否则抛出 `403 无权限查看该预约详情`。

3. **createReservation**：提交预约申请
   - 通过 `SecurityUtils` + `UserRepository` 解析当前用户，未登录返回 401。
   - 校验：
     - 实验室存在性（404）
     - 实验室状态必须为可用（status = 1），否则返回 400
     - 结束时间不能早于或等于开始时间（400）
     - 预约日期不能是过去日期（400）
     - **冲突检测**：调用 `findConflictingReservations` 检查是否有时间重叠的已通过/已使用预约，有冲突则返回 400 "预约冲突：该时间段实验室已被预约"
   - 创建一条状态为"0-待审批"的预约记录，并返回详情。

4. **approveReservation**：审批预约申请（仅管理员）
   - 仅允许从"待审批（0）"进入"已通过（1）/已拒绝（2）"，否则抛出"该预约已审批过，无法重复审批"。
   - 如果审批通过，**再次检查冲突**（防止审批期间产生新冲突），有冲突则返回 400。
   - 记录审批人 ID、审批时间、审批备注。

5. **cancelReservation**：取消预约（学生或管理员）
   - 权限：管理员或本条记录的预约人，其他用户返回 403 "无权限取消该预约"。
   - 仅允许在"0-待审批 / 1-已通过"状态下取消，否则抛出"该预约已无法取消"。
   - 将状态更新为"3-已取消"，取消备注会合并写入 `approve_remark` 字段。

6. **completeReservation**：标记预约完成（仅管理员）
   - 仅允许在状态"1-已通过"时调用，否则抛出"该预约状态不符合要求，无法标记为完成"。
   - 校验实际时间：实际结束时间不能早于或等于实际开始时间。
   - 更新实际开始/结束时间、使用备注，将状态更新为"4-已完成"。

7. **checkConflict**：检查时间冲突
   - 调用 `findConflictingReservations` 查询是否有冲突的预约。
   - 返回冲突检测结果和冲突列表（包含冲突预约的 ID、时间段、状态）。

8. **getAvailableTime**：获取可用时间段
   - 获取指定实验室在指定日期的所有已通过或已使用的预约。
   - 假设实验室开放时间为 08:00-22:00。
   - 计算空闲时间段：按开始时间排序预约，遍历计算每个预约之间的空闲时间段。
   - 返回可用时间段列表。

### 4. Controller 接口

控制器：`backend/src/main/java/org/cong/backend/reservation/controller/LaboratoryReservationController.java`

统一走 `ApiResponse<T>` 返回结构，并使用 `@SecurityRequirement(name = "bearerAuth")` + `@PreAuthorize` 控制权限。

实现的接口与 `docs/api-docs/reservation.md` 对齐：

1. **GET /api/v1/reservation**
   - 预约记录列表查询（分页 + 筛选 + 排序）。
   - 权限：管理员 / 教师 / 学生。

2. **GET /api/v1/reservation/{id}**
   - 预约记录详情。
   - 权限：管理员 / 教师 / 学生；非管理员只能查看自己的记录。

3. **POST /api/v1/reservation**
   - 提交预约申请。
   - 权限：管理员 / 教师 / 学生。

4. **PUT /api/v1/reservation/{id}/cancel**
   - 取消预约。
   - 权限：管理员 + 预约人。

5. **PUT /api/v1/reservation/{id}/approve**
   - 审批预约申请。
   - 权限：仅管理员。

6. **PUT /api/v1/reservation/{id}/complete**
   - 标记预约完成。
   - 权限：仅管理员。

7. **POST /api/v1/reservation/check-conflict**
   - 检查时间冲突。
   - 权限：管理员 / 教师 / 学生。

8. **GET /api/v1/reservation/available-time**
   - 获取可用时间段。
   - 权限：管理员 / 教师 / 学生。

## 测试记录（后端）

测试类：`backend/src/test/java/org/cong/backend/reservation/LaboratoryReservationControllerTest.java`

- **测试环境**
  - `@SpringBootTest` + `@AutoConfigureMockMvc`
  - 使用真实 MySQL 库（与其他模块一致），通过随机实验室编号 / 测试用户避免与真实数据冲突。
  - 使用 `@WithMockUser` + `user().roles(...)` 模拟不同角色（student / admin）。

- **已实现用例（8个）**

  1. **正常预约成功：申请→审批→完成 主流程闭环**
     - 学生提交预约申请，管理员审批通过并标记完成。
     - 断言：
       - 状态流转：0（待审批）→ 1（已通过）→ 4（已完成）。
       - 审批备注、实际使用时间正确记录。

  2. **时间重叠冲突检测：应该失败**
     - 创建并审批通过一个预约，尝试创建重叠时间的预约。
     - 断言：创建重叠预约应返回 400，提示"预约冲突"。

  3. **审批流转：待审批→已通过/已拒绝**
     - 测试管理员审批通过和拒绝两种场景。
     - 断言：状态正确更新，审批备注正确记录。

  4. **取消预约：学生和管理员都可以取消**
     - 测试学生取消自己的预约和管理员取消任意预约。
     - 断言：状态更新为"3-已取消"，取消备注正确记录。

  5. **状态异常测试：已通过的不能再审批等**
     - 测试已通过的预约不能再审批、已完成的预约不能再标记完成等异常场景。
     - 断言：返回 400 错误，提示相应的状态异常信息。

  6. **检查冲突接口：正确检测时间冲突**
     - 测试冲突检测接口，验证重叠时间段和不重叠时间段的检测结果。
     - 断言：重叠时间段返回 `hasConflict: true` 并包含冲突列表，不重叠返回 `hasConflict: false`。

  7. **获取可用时间段接口**
     - 创建多个已通过的预约，测试可用时间段计算。
     - 断言：返回正确的可用时间段列表。

  8. **权限测试：学生只能查看自己的预约记录**
     - 测试学生查看自己和他人的预约记录。
     - 断言：学生只能查看自己的记录，查看他人记录返回 403；管理员可以查看所有记录。

## 前端实现

### 1. API 接口封装

文件：`frontend/src/api/reservation.ts`

- 封装所有预约相关的 API 接口：
  - `getReservationList`：获取预约列表
  - `getReservationDetail`：获取预约详情
  - `createReservation`：创建预约
  - `cancelReservation`：取消预约
  - `approveReservation`：审批预约
  - `completeReservation`：标记完成
  - `checkConflict`：检查冲突
  - `getAvailableTime`：获取可用时间段
- 定义 TypeScript 接口类型：
  - `ReservationItem`：预约记录项
  - `CreateReservationRequest`：创建预约请求
  - `ApproveReservationRequest`：审批请求
  - `CancelReservationRequest`：取消请求
  - `CompleteReservationRequest`：完成请求
  - `CheckConflictRequest/Response`：冲突检测请求/响应
  - `AvailableTimeResponse`：可用时间段响应

### 2. 页面组件

#### 2.1 预约申请页面

文件：`frontend/src/views/ReservationApplyView.vue`

- **功能**
  - 选择实验室（下拉选择，仅显示可用实验室）
  - 选择预约日期（日期选择器，禁止选择过去日期）
  - 选择时间段（开始时间和结束时间选择器）
  - 实时冲突检测：选择时间段后自动调用 `checkConflict` 接口检测冲突
  - 显示可用时间段：选择实验室和日期后自动获取并显示可用时间段
  - 填写预约目的
  - 提交预约申请

- **交互**
  - 表单验证：必填项校验、时间逻辑校验（结束时间必须晚于开始时间）
  - 冲突提示：如果检测到冲突，显示红色提示信息
  - 提交成功后重置表单并显示成功提示

#### 2.2 我的预约列表页面

文件：`frontend/src/views/ReservationMyListView.vue`

- **功能**
  - 显示当前用户的所有预约记录（分页）
  - 按状态筛选（全部、待审批、已通过、已拒绝、已取消、已完成、已使用）
  - 显示预约信息：实验室名称、预约时间、状态、预约目的、备注
  - 取消预约：对于"待审批"或"已通过"状态的预约，可以取消

- **交互**
  - 表格展示预约列表，支持分页
  - 取消预约前弹出确认对话框
  - 取消成功后刷新列表

#### 2.3 预约审批页面

文件：`frontend/src/views/ReservationApprovalView.vue`

- **功能**
  - 显示所有预约记录（分页，管理员可查看全部）
  - 按状态筛选（默认显示"待审批"）
  - 审批操作：
    - 对于"待审批"状态的预约，可以"通过"或"拒绝"
    - 对于"已通过"状态的预约，可以"标记完成"
  - 显示预约信息：实验室名称、预约人、预约时间、状态、预约目的、备注

- **交互**
  - 表格展示预约列表，支持分页
  - 审批操作按钮根据状态动态显示
  - 标记完成时弹出输入框，可输入使用备注

### 3. 路由配置

文件：`frontend/src/router/index.ts`

新增路由：

- `/reservation/apply`：预约申请页面
- `/reservation/my`：我的预约列表页面
- `/reservation/approval`：预约审批页面（管理员）

所有路由均需要认证（`requiresAuth: true`）。

## 核心特性

### 1. 时间冲突检测

- **创建预约时**：自动检测是否有时间重叠的已通过/已使用预约
- **审批通过时**：再次检测冲突（防止审批期间产生新冲突）
- **冲突检测接口**：提供独立的冲突检测接口，前端可实时检测

### 2. 状态流转

- **待审批（0）** → **已通过（1）** / **已拒绝（2）**（管理员审批）
- **待审批（0）** / **已通过（1）** → **已取消（3）**（学生或管理员取消）
- **已通过（1）** → **已完成（4）**（管理员标记完成）

### 3. 权限控制

- **查看权限**：管理员可查看所有预约，学生/教师只能查看自己的预约
- **操作权限**：
  - 创建预约：所有角色
  - 取消预约：预约人或管理员
  - 审批预约：仅管理员
  - 标记完成：仅管理员

### 4. 可用时间段计算

- 基于已通过/已使用的预约记录，计算指定实验室在指定日期的可用时间段
- 假设实验室开放时间为 08:00-22:00
- 返回空闲时间段列表，方便用户选择

## 测试结果

- **后端测试**：8 个测试用例全部通过
- **前端功能**：已完成所有页面和交互功能
- **接口对接**：前后端接口已对齐，符合接口文档规范

## 后续工作建议

- **前端菜单集成**：在导航菜单中添加预约相关入口
- **用户体验优化**：
  - 预约申请页面可增加日历视图，直观显示已预约时间段
  - 可用时间段可点击快速填充到表单
- **功能扩展**：
  - 支持批量预约
  - 支持预约提醒（预约前提醒、到期提醒）
  - 支持预约统计报表

