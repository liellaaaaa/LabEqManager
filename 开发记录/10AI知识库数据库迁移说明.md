# AI知识库数据库迁移说明

## 概述

本次更新将AI助手的知识库从硬编码的静态Map迁移到MySQL数据库，实现了知识库的动态管理。

## 主要变更

### 1. 新增实体类
- **AiKnowledge** (`backend/src/main/java/org/cong/backend/ai/entity/AiKnowledge.java`)
  - 对应数据库表 `ai_knowledge`
  - 包含字段：id, question, answer, category, keywords, status, createTime, updateTime

### 2. 新增Repository接口
- **AiKnowledgeRepository** (`backend/src/main/java/org/cong/backend/ai/repository/AiKnowledgeRepository.java`)
  - 提供知识库查询方法
  - 支持按状态查询、关键词模糊查询、分类查询

### 3. 修改服务类
- **AiAssistantService** (`backend/src/main/java/org/cong/backend/ai/service/AiAssistantService.java`)
  - 移除了静态的 `KNOWLEDGE_BASE` Map
  - 修改 `matchKnowledgeBase()` 方法，从数据库查询知识库
  - 实现了多级匹配策略：
    1. **完全匹配**：用户输入与问题字段完全一致
    2. **包含匹配**：用户输入包含问题，或问题包含用户输入
    3. **关键词匹配**：提取用户输入关键词，与问题字段和keywords字段匹配
    4. **模糊查询**：使用Repository的模糊查询方法

## 匹配策略说明

### 匹配优先级（从高到低）

1. **完全匹配**：用户输入与知识库的 `question` 字段完全一致（忽略大小写）
2. **包含匹配**：用户输入包含问题，或问题包含用户输入的核心部分（至少3个字符）
3. **关键词匹配**：
   - 提取用户输入的关键词（去除停用词）
   - 与知识库的 `question` 字段匹配
   - 与知识库的 `keywords` 字段匹配（支持逗号、顿号、空格分隔）
4. **模糊查询**：使用数据库的LIKE查询，在 `question` 和 `keywords` 字段中搜索

### 关键词提取规则

- 提取2-4个字的短语
- 提取单个词（长度≥2）
- 过滤常见停用词（的、了、在、是、如何、怎么等）

## 数据库初始化

### 执行步骤

1. 确保已执行 `lab_equipment_manager.sql` 创建表结构
2. 执行 `lab_equipment_manager_ai_knowledge_init.sql` 初始化知识库数据

### 知识库数据结构

```sql
CREATE TABLE `ai_knowledge` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '知识ID',
  `question` VARCHAR(500) NOT NULL COMMENT '问题',
  `answer` TEXT NOT NULL COMMENT '答案',
  `category` VARCHAR(100) DEFAULT NULL COMMENT '分类',
  `keywords` VARCHAR(200) DEFAULT NULL COMMENT '关键词',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI知识库表';
```

### 字段说明

- **question**：问题文本，用于匹配用户输入
- **answer**：答案文本，匹配成功后返回给用户
- **category**：分类，便于管理和查询（如：设备管理、实验室管理、系统说明）
- **keywords**：关键词，多个关键词用逗号、顿号或空格分隔，用于提高匹配准确率
- **status**：状态，0-禁用，1-启用（只有启用的知识才会被匹配）

## 使用建议

### 添加知识库条目

1. **直接插入数据库**：
```sql
INSERT INTO `ai_knowledge` (`question`, `answer`, `category`, `keywords`, `status`) 
VALUES ('问题文本', '答案文本', '分类', '关键词1,关键词2,关键词3', 1);
```

2. **通过管理界面**（如果已实现）：
   - 管理员可以在系统中添加、编辑、删除知识库条目

### 关键词设置建议

- 设置多个同义词或相关词，提高匹配率
- 例如："设备借用" 的关键词可以设置为："设备借用,借用设备,如何借用,借用流程,设备申请"
- 使用逗号、顿号或空格分隔多个关键词

### 分类管理建议

- 建议使用统一的分类体系，如：
  - 设备管理
  - 实验室管理
  - 课程管理
  - 系统说明
  - 其他

## 性能优化

### 当前实现

- 每次查询都会从数据库加载所有启用的知识库记录到内存
- 适合知识库条目较少的情况（< 1000条）

### 未来优化建议

如果知识库条目较多，可以考虑：

1. **缓存机制**：使用Redis或本地缓存缓存知识库数据
2. **分页查询**：按分类或关键词预筛选，减少查询数据量
3. **全文搜索**：使用MySQL的全文索引或Elasticsearch提高搜索效率
4. **相似度算法**：使用编辑距离、余弦相似度等算法提高匹配准确率

## 注意事项

1. **状态管理**：只有 `status = 1` 的知识库条目才会被匹配
2. **大小写不敏感**：所有匹配都是大小写不敏感的
3. **匹配顺序**：按照优先级顺序匹配，找到第一个匹配即返回
4. **日志记录**：匹配过程会记录debug日志，便于调试和优化

## 测试建议

1. **完全匹配测试**：输入与知识库问题完全一致的内容
2. **包含匹配测试**：输入包含知识库问题的内容
3. **关键词匹配测试**：输入知识库关键词中的词汇
4. **模糊匹配测试**：输入与知识库问题相似但不完全一致的内容
5. **未匹配测试**：输入与知识库无关的内容，验证是否会调用通义千问API

## 回退方案

如果需要回退到硬编码方式：

1. 恢复 `AiAssistantService` 中的静态 `KNOWLEDGE_BASE` Map
2. 移除 `AiKnowledgeRepository` 的注入
3. 恢复原来的 `matchKnowledgeBase()` 方法实现

---

**更新日期**：2026-02-8  
**版本**：V1.0

