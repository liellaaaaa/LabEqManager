# 维修与报废管理模块开发记录（equipment_repair + equipment_scrap）

## 开发目标

实现功能清单中“设备全生命周期管理”的核心功能：**设备维修管理**和**设备报废管理**，形成完整的设备生命周期管理闭环。

参考文档：
- 接口文档：`docs/api-docs/repair-scrap.md`
- 数据库结构：`lab_equipment_manager.sql` 中的 `equipment_repair` 和 `equipment_scrap` 表

## 数据库设计（回顾）

### 设备维修记录表 `equipment_repair`

- **核心字段**
  - `id`：维修记录 ID
  - `equipment_id`：设备 ID（外键，关联 `equipment.id`）
  - `reporter_id`：报修人 ID（外键，关联 `user.id`）
  - `report_date`：报修日期
  - `fault_description`：故障描述（TEXT）
  - `repair_result`：维修结果（TEXT，可选）
  - `repair_date`：维修日期（可选）
  - `status`：状态（0-待维修，1-维修中，2-已修好，3-无法修复）
  - `create_time` / `update_time`：创建 / 更新时间

### 设备报废记录表 `equipment_scrap`

- **核心字段**
  - `id`：报废记录 ID
  - `equipment_id`：设备 ID（外键，关联 `equipment.id`）
  - `applicant_id`：申请人 ID（外键，关联 `user.id`）
  - `apply_date`：申请日期
  - `scrap_reason`：报废原因（TEXT）
  - `status`：状态（0-待审批，1-已通过，2-已拒绝）
  - `approver_id`：审批人 ID（外键，关联 `user.id`）
  - `approve_time`：审批时间
  - `approve_remark`：审批备注
  - `create_time` / `update_time`：创建 / 更新时间

## 后端实现

### 1. 实体 & 仓储

#### 维修模块

- **实体**
  - `backend/src/main/java/org/cong/backend/repair/entity/EquipmentRepair.java`
    - 与 `equipment_repair` 表一一对应，使用 JPA 映射 + `@PrePersist` / `@PreUpdate` 自动维护时间字段。

- **仓储**
  - `backend/src/main/java/org/cong/backend/repair/repository/EquipmentRepairRepository.java`
    - 继承 `JpaRepository` 和 `JpaSpecificationExecutor`，支持动态查询。

#### 报废模块

- **实体**
  - `backend/src/main/java/org/cong/backend/scrap/entity/EquipmentScrap.java`
    - 与 `equipment_scrap` 表一一对应，使用 JPA 映射 + `@PrePersist` / `@PreUpdate` 自动维护时间字段。

- **仓储**
  - `backend/src/main/java/org/cong/backend/scrap/repository/EquipmentScrapRepository.java`
    - 继承 `JpaRepository` 和 `JpaSpecificationExecutor`，支持动态查询。

### 2. DTO & 状态常量

#### 维修模块

- `RepairStatus`：封装状态值及中文名称映射（0-待维修，1-维修中，2-已修好，3-无法修复）
- 请求 DTO：
  - `CreateRepairRequest`：提交维修申请
  - `UpdateRepairStatusRequest`：更新维修状态（仅管理员）
- 响应 DTO：
  - `RepairListResponse`：维修记录列表项（包含设备名、报修人姓名、状态名称等）
  - `RepairDetailResponse`：维修记录详情
  - `RepairStatsResponse`：维修统计数据

#### 报废模块

- `ScrapStatus`：封装状态值及中文名称映射（0-待审批，1-已通过，2-已拒绝）
- 请求 DTO：
  - `CreateScrapRequest`：提交报废申请
  - `ApproveScrapRequest`：审批报废申请（仅管理员）
- 响应 DTO：
  - `ScrapListResponse`：报废记录列表项（包含设备名、申请人姓名、审批人姓名、状态名称等）
  - `ScrapDetailResponse`：报废记录详情
  - `ScrapStatsResponse`：报废统计数据

### 3. Service 业务逻辑

#### 维修模块 Service

实现类：`backend/src/main/java/org/cong/backend/repair/service/EquipmentRepairService.java`

- **依赖**
  - `EquipmentRepairRepository`：维修记录持久化
  - `EquipmentRepository`：设备信息
  - `UserRepository`：报修人信息
  - `SecurityUtils`：获取当前登录用户及角色

- **核心方法**

1. **getRepairList**：维修记录列表查询
   - 支持分页、按设备 / 报修人 / 状态 / 报修日期范围过滤、排序。
   - 权限规则：
     - 管理员：可通过 `reporterId` 参数查看任意用户记录。
     - 教师 / 学生：强制仅能查看自己的维修记录（忽略外部传入的 `reporterId`）。

2. **getRepairDetail**：维修记录详情
   - 管理员可查看全部；非管理员只能查看自己的记录，否则抛出 `403 无权限查看该维修记录`。

3. **createRepair**：提交维修申请
   - 通过 `SecurityUtils` + `UserRepository` 解析当前用户，未登录返回 401。
   - 校验：
     - 设备存在性（404）
     - 故障描述不能为空（400）
   - 创建一条状态为“0-待维修”的维修记录，并返回详情。

4. **updateRepairStatus**：更新维修状态（仅管理员）
   - 校验状态值有效性（0-3）
   - 当状态为“2-已修好”或“3-无法修复”时，维修结果和维修日期必填。
   - 更新维修状态、维修结果、维修日期。

5. **getRepairStats**：获取维修统计（仅管理员）
   - 支持按设备、日期范围筛选。
   - 统计：总维修次数、待维修数量、维修中数量、已修好数量、无法修复数量、维修成功率。

#### 报废模块 Service

实现类：`backend/src/main/java/org/cong/backend/scrap/service/EquipmentScrapService.java`

- **依赖**
  - `EquipmentScrapRepository`：报废记录持久化
  - `EquipmentRepository`：设备信息
  - `UserRepository`：申请人 / 审批人信息
  - `SecurityUtils`：获取当前登录用户及角色

- **核心方法**

1. **getScrapList**：报废记录列表查询
   - 支持分页、按设备 / 申请人 / 状态 / 申请日期范围过滤、排序。
   - 权限规则：
     - 管理员：可通过 `applicantId` 参数查看任意用户记录。
     - 教师 / 学生：强制仅能查看自己的报废记录（忽略外部传入的 `applicantId`）。

2. **getScrapDetail**：报废记录详情
   - 管理员可查看全部；非管理员只能查看自己的记录，否则抛出 `403 无权限查看该报废记录`。

3. **createScrap**：提交报废申请
   - 通过 `SecurityUtils` + `UserRepository` 解析当前用户，未登录返回 401。
   - 校验：
     - 设备存在性（404）
     - 报废原因不能为空（400）
   - 创建一条状态为“0-待审批”的报废记录，并返回详情。

4. **approveScrap**：审批报废申请（仅管理员）
   - 仅允许从“待审批（0）”进入“已通过（1）/已拒绝（2）”，否则抛出“该报废申请已审批过，无法重复审批”。
   - 记录审批人 ID、审批时间、审批备注。

5. **getScrapStats**：获取报废统计（仅管理员）
   - 支持按日期范围筛选。
   - 统计：总报废申请数、待审批数量、已通过数量、已拒绝数量、审批通过率。

### 4. Controller 接口层

#### 维修模块 Controller

实现类：`backend/src/main/java/org/cong/backend/repair/controller/EquipmentRepairController.java`

- **接口列表**
  - `GET /api/v1/repair`：获取维修记录列表（管理员/教师/学生）
  - `GET /api/v1/repair/{id}`：获取维修记录详情（管理员/教师/学生）
  - `POST /api/v1/repair`：提交维修申请（管理员/教师/学生）
  - `PUT /api/v1/repair/{id}/status`：更新维修状态（仅管理员）
  - `GET /api/v1/repair/stats`：获取维修统计（仅管理员）

#### 报废模块 Controller

实现类：`backend/src/main/java/org/cong/backend/scrap/controller/EquipmentScrapController.java`

- **接口列表**
  - `GET /api/v1/scrap`：获取报废记录列表（管理员/教师/学生）
  - `GET /api/v1/scrap/{id}`：获取报废记录详情（管理员/教师/学生）
  - `POST /api/v1/scrap`：提交报废申请（管理员/教师/学生）
  - `PUT /api/v1/scrap/{id}/approve`：审批报废申请（仅管理员）
  - `GET /api/v1/scrap/stats`：获取报废统计（仅管理员）

## 前端实现

### 1. API 接口封装

#### 维修模块 API

文件：`frontend/src/api/repair.ts`

- 定义 TypeScript 接口类型：
  - `RepairItem`：维修记录项
  - `CreateRepairRequest`：创建维修申请请求
  - `UpdateRepairStatusRequest`：更新维修状态请求
  - `RepairStatsResponse`：维修统计响应
- API 方法：
  - `getRepairList`：获取维修记录列表
  - `getRepairDetail`：获取维修记录详情
  - `createRepair`：提交维修申请
  - `updateRepairStatus`：更新维修状态
  - `getRepairStats`：获取维修统计

#### 报废模块 API

文件：`frontend/src/api/scrap.ts`

- 定义 TypeScript 接口类型：
  - `ScrapItem`：报废记录项
  - `CreateScrapRequest`：创建报废申请请求
  - `ApproveScrapRequest`：审批报废申请请求
  - `ScrapStatsResponse`：报废统计响应
- API 方法：
  - `getScrapList`：获取报废记录列表
  - `getScrapDetail`：获取报废记录详情
  - `createScrap`：提交报废申请
  - `approveScrap`：审批报废申请
  - `getScrapStats`：获取报废统计

### 2. 页面组件

#### 2.1 维修申请页面

文件：`frontend/src/views/RepairApplyView.vue`

- **功能**
  - 选择设备（通过设备ID输入）
  - 选择报修日期（日期时间选择器）
  - 填写故障描述（多行文本输入）
  - 提交维修申请

- **交互**
  - 表单验证：必填项校验
  - 提交成功后重置表单并显示成功提示

#### 2.2 我的维修列表页面

文件：`frontend/src/views/RepairMyListView.vue`

- **功能**
  - 显示当前用户的所有维修记录（分页）
  - 按状态筛选（全部、待维修、维修中、已修好、无法修复）
  - 显示维修信息：设备名称、设备型号、状态、报修日期、故障描述、维修结果、维修日期

- **交互**
  - 表格展示维修列表，支持分页
  - 状态筛选后自动刷新列表

#### 2.3 维修管理页面

文件：`frontend/src/views/RepairManagementView.vue`

- **功能**
  - 显示所有维修记录（分页，管理员可查看全部）
  - 按状态筛选（全部、待维修、维修中、已修好、无法修复）
  - 更新维修状态：点击“更新状态”按钮，弹出对话框
  - 状态更新对话框：
    - 选择维修状态（下拉选择）
    - 填写维修结果（当状态为“已修好”或“无法修复”时必填）
    - 选择维修日期（当状态为“已修好”或“无法修复”时必填）

- **交互**
  - 表格展示维修列表，支持分页
  - 状态更新对话框：表单验证、提交成功后刷新列表

#### 2.4 报废申请页面

文件：`frontend/src/views/ScrapApplyView.vue`

- **功能**
  - 选择设备（通过设备ID输入）
  - 选择申请日期（日期时间选择器）
  - 填写报废原因（多行文本输入）
  - 提交报废申请

- **交互**
  - 表单验证：必填项校验
  - 提交成功后重置表单并显示成功提示

#### 2.5 我的报废列表页面

文件：`frontend/src/views/ScrapMyListView.vue`

- **功能**
  - 显示当前用户的所有报废记录（分页）
  - 按状态筛选（全部、待审批、已通过、已拒绝）
  - 显示报废信息：设备名称、设备型号、状态、申请日期、报废原因、审批人、审批时间、审批备注

- **交互**
  - 表格展示报废列表，支持分页
  - 状态筛选后自动刷新列表

#### 2.6 报废审批页面

文件：`frontend/src/views/ScrapApprovalView.vue`

- **功能**
  - 显示所有报废记录（分页，管理员可查看全部）
  - 按状态筛选（待审批、已通过、已拒绝、全部）
  - 审批报废申请：点击“通过”或“拒绝”按钮，弹出对话框
  - 审批对话框：
    - 显示审批结果（通过/拒绝）
    - 填写审批备注（可选）

- **交互**
  - 表格展示报废列表，支持分页
  - 审批对话框：提交成功后刷新列表

### 3. 路由配置

文件：`frontend/src/router/index.ts`

新增路由：
- `/repair/apply`：维修申请页面
- `/repair/my`：我的维修列表页面
- `/repair/management`：维修管理页面（仅管理员）
- `/scrap/apply`：报废申请页面
- `/scrap/my`：我的报废列表页面
- `/scrap/approval`：报废审批页面（仅管理员）

### 4. 菜单配置

文件：`frontend/src/views/HomeView.vue`

新增菜单项：
- **维修模块**
  - 申请维修（所有用户）
  - 我的维修（所有用户）
  - 维修管理（仅管理员）
- **报废模块**
  - 申请报废（所有用户）
  - 我的报废（所有用户）
  - 报废审批（仅管理员）

## 权限控制

### 维修模块

- **查看列表/详情**：管理员、教师、学生（`@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")`）
  - 管理员：可查看所有记录
  - 教师/学生：只能查看自己的记录
- **提交申请**：管理员、教师、学生（`@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")`）
- **更新状态**：仅管理员（`@PreAuthorize("hasRole('admin')")`）
- **查看统计**：仅管理员（`@PreAuthorize("hasRole('admin')")`）

### 报废模块

- **查看列表/详情**：管理员、教师、学生（`@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")`）
  - 管理员：可查看所有记录
  - 教师/学生：只能查看自己的记录
- **提交申请**：管理员、教师、学生（`@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")`）
- **审批申请**：仅管理员（`@PreAuthorize("hasRole('admin')")`）
- **查看统计**：仅管理员（`@PreAuthorize("hasRole('admin')")`）

## 测试

### 后端测试

#### 维修模块测试

文件：`backend/src/test/java/org/cong/backend/repair/EquipmentRepairControllerTest.java`

测试用例：
- 提交维修申请（学生角色）
- 获取维修记录列表（管理员）
- 获取维修记录详情（权限控制）
- 更新维修状态（管理员）
- 获取维修统计（管理员）

#### 报废模块测试

文件：`backend/src/test/java/org/cong/backend/scrap/EquipmentScrapControllerTest.java`

测试用例：
- 提交报废申请（教师角色）
- 获取报废记录列表（管理员）
- 获取报废记录详情（权限控制）
- 审批报废申请（通过/拒绝）
- 重复审批验证
- 获取报废统计（管理员）

## 功能特性

1. **权限控制**
   - 管理员可查看所有记录
   - 教师/学生只能查看自己的记录
   - 状态更新和审批仅管理员可操作

2. **数据验证**
   - 请求参数验证
   - 状态流转验证
   - 重复操作验证

3. **统计功能**
   - 维修统计（总数、各状态数量、维修成功率）
   - 报废统计（总数、各状态数量、审批通过率）

4. **用户体验**
   - 清晰的状态展示
   - 友好的错误提示
   - 便捷的筛选和分页

## 总结

维修与报废管理模块已完成开发，包括：

1. **后端实现**
   - 实体类、Repository、DTO、Service、Controller 完整实现
   - 权限控制、数据验证、业务逻辑完整

2. **前端实现**
   - API 接口封装
   - 6 个页面组件（维修申请、我的维修、维修管理、报废申请、我的报废、报废审批）
   - 路由配置和菜单配置

3. **测试**
   - 后端测试代码完整，测试用例覆盖主要功能

该模块与设备借用、实验室预约等模块共同构成了完整的设备全生命周期管理系统。

