# 用户与角色管理模块开发记录

## 开发时间
2026年1月15日

## 开发目标
实现功能清单中必做功能第一项：**用户与角色管理（RBAC 基础版）**

## 功能需求
根据 `docs/功能清单_规则文件.md` 和 `docs/api-docs/auth.md`、`docs/api-docs/user.md` 的要求，实现以下功能：

### 1. 用户登录/注销
- 用户登录接口（JWT Token 认证）
- 用户注销接口
- 获取当前用户信息接口

### 2. 基本角色划分
- 管理员（admin）
- 教师（teacher）
- 学生（student）

### 3. 基于角色的功能权限控制
- 角色权限可通过代码或初始化数据配置
- 不做角色继承
- 不做动态权限配置界面

### 4. JWT 身份认证
- 使用 JWT Token 进行身份认证
- Token 有效期：86400秒（24小时）

### 5. Spring Security 权限校验
- 集成 Spring Security（当前阶段暂时禁用自动配置，便于接口测试）

## 技术栈

### 后端框架
- Spring Boot 3.2.5
- Spring Data JPA
- Spring Security（已集成但当前禁用自动配置）
- JWT（jjwt 0.11.5）

### 数据库
- MySQL 8.0+
- 字符编码：utf8（兼容性考虑）

### 开发工具
- Swagger/OpenAPI 3（springdoc-openapi 2.5.0）
- Lombok
- Maven

## 实现的接口

### 认证模块（AuthController）
1. **POST /api/v1/auth/login** - 用户登录
   - 请求体：username, password
   - 响应：token + userInfo
   - 权限：公开访问

2. **POST /api/v1/auth/logout** - 用户注销
   - 请求头：Authorization: Bearer {token}
   - 响应：成功消息
   - 权限：已登录用户

3. **GET /api/v1/auth/me** - 获取当前用户信息
   - 请求头：Authorization: Bearer {token}
   - 响应：用户详细信息
   - 权限：已登录用户

### 用户管理模块（UserController）
1. **GET /api/v1/users** - 获取用户列表
   - 支持分页（page, size）
   - 支持筛选（username, name, department, roleCode, status）
   - 支持排序（sortBy, sortOrder）
   - 权限：管理员（TODO：待实现权限校验）

2. **GET /api/v1/users/{id}** - 获取用户详情
   - 权限：管理员/当前用户（TODO：待实现权限校验）

3. **POST /api/v1/users** - 创建用户
   - 请求体：username, password, name, email, phone, department, roleCode, status
   - 权限：管理员（TODO：待实现权限校验）

4. **PUT /api/v1/users/{id}** - 更新用户
   - 请求体：name, email, phone, department, roleCode, status（可选字段）
   - 权限：管理员（TODO：待实现权限校验）

5. **DELETE /api/v1/users/{id}** - 删除用户
   - 权限：管理员（TODO：待实现权限校验）

6. **PUT /api/v1/users/{id}/password** - 更新用户密码
   - 请求体：oldPassword（当前用户修改自己密码时必填）, newPassword
   - 权限：管理员/当前用户（TODO：待实现权限校验）

7. **DELETE /api/v1/users/batch** - 批量删除用户
   - 请求体：ids（用户ID列表）
   - 权限：管理员（TODO：待实现权限校验）

### 角色管理模块（RoleController）
1. **GET /api/v1/roles** - 获取角色列表
   - 响应：所有角色信息（id, name, code, description）
   - 权限：管理员/教师（TODO：待实现权限校验）

## 数据库设计

### 核心表结构
- `user` - 用户表
  - 字段：id, username, password, name, email, phone, department, role_code, status, create_time, update_time
  - 索引：username（唯一），role_code

- `role` - 角色表
  - 字段：id, name, code, description, create_time
  - 索引：code（唯一）

- `user_role` - 用户角色关联表
  - 字段：user_id, role_id
  - 外键关联：user.id, role.id

### 初始化数据
- 默认角色：系统管理员（admin）、教师（teacher）、学生（student）
- 默认管理员账号：admin / admin123（密码暂时明文存储，后续改为BCrypt加密）

## 代码结构

```
backend/src/main/java/org/cong/backend/
├── auth/                          # 认证模块
│   ├── AuthController.java       # 认证控制器
│   └── dto/                       # 数据传输对象
│       ├── LoginRequest.java
│       ├── LoginResponse.java
│       └── UserInfoResponse.java
├── user/                          # 用户管理模块
│   ├── controller/
│   │   ├── UserController.java   # 用户管理控制器
│   │   └── RoleController.java   # 角色管理控制器
│   ├── service/
│   │   ├── UserService.java      # 用户业务逻辑
│   │   └── RoleService.java      # 角色业务逻辑
│   ├── repository/
│   │   ├── UserRepository.java   # 用户数据访问
│   │   └── RoleRepository.java   # 角色数据访问
│   ├── entity/
│   │   ├── User.java             # 用户实体
│   │   └── Role.java             # 角色实体
│   └── dto/                       # 数据传输对象
│       ├── CreateUserRequest.java
│       ├── UpdateUserRequest.java
│       ├── UpdatePasswordRequest.java
│       ├── UserListResponse.java
│       ├── PageResponse.java
│       ├── BatchDeleteRequest.java
│       └── RoleResponse.java
├── security/                      # 安全模块
│   ├── JwtTokenProvider.java     # JWT工具类
│   ├── JwtProperties.java        # JWT配置属性
│   └── CustomUserDetailsService.java  # 用户详情服务（暂未使用）
├── config/                        # 配置类
│   ├── OpenApiConfig.java        # Swagger配置
│   └── PasswordConfig.java      # 密码编码器配置
└── common/                        # 通用类
    └── ApiResponse.java          # 统一响应格式
```

## 开发过程中遇到的问题及解决方案

### 问题1：pom.xml 依赖重复
**现象**：编译时提示依赖重复或配置错误

**原因**：pom.xml 文件在之前的编辑过程中可能出现了重复的 `<project>` 标签或依赖声明

**解决方案**：
- 清理 pom.xml，确保只有一个完整的 `<project>` 标签
- 移除重复的依赖声明
- 简化 maven-compiler-plugin 配置，移除手动配置的 annotationProcessorPaths（Spring Boot 已自动处理 Lombok）

### 问题2：JWT 密钥 Base64 解码失败
**现象**：应用启动时报错 `Illegal base64 character: '-'`

**原因**：`JwtTokenProvider` 构造函数中尝试将配置的密钥字符串当作 Base64 编码进行解码，但配置文件中使用的是普通字符串（包含 `-` 等非 Base64 字符）

**解决方案**：
- 修改 `JwtTokenProvider`，直接使用明文字符串作为签名密钥
- 将 `Decoders.BASE64.decode(properties.getSecret())` 改为 `properties.getSecret().getBytes(StandardCharsets.UTF_8)`
- 这样可以使用任意字符串作为密钥，不需要 Base64 编码

### 问题3：Spring Security 自动配置导致 403 错误
**现象**：在 Swagger 中测试登录接口时返回 403 Forbidden，而不是业务逻辑返回的 401

**原因**：Spring Security 的自动配置在请求到达 Controller 之前就拦截了请求

**解决方案**：
- 在 `BackendApplication` 上添加 `@SpringBootApplication(exclude = SecurityAutoConfiguration.class)` 暂时禁用 Spring Security 自动配置
- 这样可以让接口先正常跑通，便于测试
- 后续等接口验证完成后，再重新启用 Spring Security 并配置 JWT 过滤链

### 问题4：数据库字符编码不支持 utf8mb4
**现象**：应用启动时报错 `Unsupported character encoding 'utf8mb4'`

**原因**：本地 MySQL 版本或配置不支持 utf8mb4 字符集

**解决方案**：
- 修改 `application.yml` 中的数据库连接 URL
- 将 `characterEncoding=utf8mb4` 改为 `characterEncoding=utf8`
- 同时添加 `database-platform: org.hibernate.dialect.MySQLDialect` 明确指定数据库方言

### 问题5：UserRepository 缺少 Specification 支持
**现象**：编译错误，提示 `findAll(Specification, Pageable)` 方法不存在

**原因**：`UserRepository` 只继承了 `JpaRepository`，没有继承 `JpaSpecificationExecutor`，无法使用 Specification 进行动态查询

**解决方案**：
- 修改 `UserRepository` 接口，同时继承 `JpaRepository<User, Long>` 和 `JpaSpecificationExecutor<User>`
- 这样可以在 `UserService` 中使用 `Specification` 构建动态查询条件

### 问题6：Swagger 中 Authorization Token 传递问题
**现象**：在 Swagger 中测试 `/api/v1/auth/me` 接口时，即使填写了 Authorization 参数，仍然返回 401 未授权

**原因**：
1. Swagger UI 中手动填写的 Authorization 参数格式不正确（缺少 `Bearer` 前缀）
2. 接口没有标注 `@SecurityRequirement` 注解，Swagger 不会显示 Authorize 按钮

**解决方案**：
1. 在 `/me` 接口上添加 `@SecurityRequirement(name = "bearerAuth")` 注解
2. 优化代码逻辑，兼容两种格式：
   - 标准格式：`Bearer {token}`
   - 兼容格式：直接 `{token}`（自动处理）
3. 在 `OpenApiConfig` 中已配置 `bearerAuth` 安全方案
4. 用户可以在 Swagger UI 右上角点击 "Authorize" 按钮，输入 token 后自动应用到所有需要认证的接口

### 问题7：密码存储方式
**现象**：数据库中的管理员密码与登录时输入的密码不匹配

**原因**：SQL 初始化脚本中的密码是 BCrypt 哈希值，但实际数据库中可能是明文

**解决方案**：
- 暂时支持两种密码验证方式：
  1. 优先使用 BCrypt 验证（符合最终安全要求）
  2. 如果 BCrypt 验证失败，再尝试明文比较（兼容开发阶段）
- 后续等所有接口测试通过后，统一将所有密码改为 BCrypt 加密存储

## 待完成的工作

### 1. 权限校验实现
- 当前所有接口的权限校验都标记为 TODO
- 需要重新启用 Spring Security，配置 JWT 过滤链
- 实现基于角色的访问控制（RBAC）
- 在 Controller 方法上添加权限校验逻辑

### 2. 密码加密
- 当前密码暂时明文存储，便于开发测试
- 后续需要将所有密码改为 BCrypt 加密存储
- 创建密码迁移脚本或工具

### 3. 异常处理优化
- 当前使用 `RuntimeException` 抛出业务异常
- 后续可以创建自定义异常类，提供更详细的错误信息

### 4. 日志记录
- 添加操作日志记录（用户登录、创建、更新、删除等操作）
- 记录关键业务操作的审计日志

## 测试验证

### 已测试通过的接口
- ✅ POST /api/v1/auth/login - 登录成功，返回 token 和用户信息
- ✅ GET /api/v1/auth/me - 通过 Swagger Authorize 功能成功获取当前用户信息
- ✅ POST /api/v1/auth/logout - 注销成功
- ✅ GET /api/v1/users - 用户列表查询（分页、筛选、排序）
- ✅ GET /api/v1/users/{id} - 用户详情查询
- ✅ POST /api/v1/users - 创建用户
- ✅ PUT /api/v1/users/{id} - 更新用户
- ✅ DELETE /api/v1/users/{id} - 删除用户
- ✅ PUT /api/v1/users/{id}/password - 更新密码
- ✅ DELETE /api/v1/users/batch - 批量删除用户
- ✅ GET /api/v1/roles - 获取角色列表

### 测试工具
- Swagger UI：`http://localhost:8080/swagger-ui/index.html`
- 使用 Swagger 的 Authorize 功能统一管理 JWT Token

## 总结

本次开发完成了用户与角色管理模块的核心功能，包括：
- 用户认证（登录、注销、获取当前用户）
- 用户管理（CRUD、密码更新、批量删除）
- 角色管理（获取角色列表）
- JWT Token 生成和验证
- Swagger API 文档集成

所有接口已按照 API 文档规范实现，并在 Swagger 中测试通过。后续需要完成权限校验的实现，将 Spring Security 重新启用并配置 JWT 过滤链，实现完整的 RBAC 权限控制。
