# 实验室管理与设备基础模块开发记录

## 开发目标
实现功能清单中必做功能第二项：**实验室管理 + 设备基础（laboratory + equipment + equipment_status）**

## 功能需求
根据 `docs/api-docs/laboratory.md` 和 `docs/api-docs/equipment.md` 的要求，实现以下功能：

### 1. 实验室管理
- 实验室列表查询（分页、筛选、排序）
- 实验室详情查询
- 创建实验室
- 更新实验室信息
- 删除实验室
- 批量删除实验室
- 更新实验室状态
- 获取实验室设备列表

### 2. 设备管理
- 设备列表查询（分页、筛选、排序）
- 设备详情查询
- 创建设备（必须关联到实验室）
- 更新设备信息
- 删除设备
- 批量删除设备
- 更新设备状态
- 获取设备状态列表

### 3. 前端页面
- 实验室列表页（列表 + 新增/编辑弹窗 + 状态切换）
- 设备列表页（列表 + 筛选 + 详情 + 所属实验室展示）
- 菜单：登录后显示"实验室管理""设备管理"入口

## 技术栈

### 后端框架
- Spring Boot 3.2.5
- Spring Data JPA
- Spring Security（权限控制）
- JWT（身份认证）

### 数据库
- MySQL 8.0+
- 字符编码：utf8mb4

### 前端框架
- Vue 3.5.26
- Element Plus 2.13.1
- TypeScript
- Vue Router 4.6.4
- Pinia 3.0.4

## 数据库设计

### 核心表结构
- `laboratory` - 实验室表
  - 字段：id, name, code, location, area, capacity, type, status, manager_id, description, create_time, update_time
  - 索引：code（唯一），manager_id（外键关联user表）

- `equipment` - 设备表
  - 字段：id, name, model, specification, asset_code, unit_price, quantity, supplier, purchase_date, warranty_period, status_id, laboratory_id, description, create_time, update_time
  - 索引：asset_code（唯一），status_id（外键关联equipment_status表），laboratory_id（外键关联laboratory表）

- `equipment_status` - 设备状态表
  - 字段：id, name, code, description
  - 索引：code（唯一）

### 关联关系
- 设备必须关联到某个实验室（laboratory_id 必填，不能是自由文本位置）
- 设备关联设备状态（status_id 必填）
- 实验室可关联负责人（manager_id 可选，关联user表）

## 实现的接口

### 实验室管理模块（LaboratoryController）
1. **GET /api/v1/laboratory** - 获取实验室列表
   - 支持分页（page, size）
   - 支持筛选（name, code, location, type, status, managerId）
   - 支持排序（sortBy, sortOrder）
   - 权限：管理员/教师/学生（所有角色可查看）

2. **GET /api/v1/laboratory/{id}** - 获取实验室详情
   - 包含设备数量统计
   - 权限：管理员/教师/学生

3. **POST /api/v1/laboratory** - 创建实验室
   - 请求体：name, code, location, area, capacity, type, status, managerId, description
   - 权限：管理员

4. **PUT /api/v1/laboratory/{id}** - 更新实验室
   - 请求体：name, code, location, area, capacity, type, managerId, description（可选字段）
   - 权限：管理员

5. **DELETE /api/v1/laboratory/{id}** - 删除实验室
   - 权限：管理员

6. **DELETE /api/v1/laboratory/batch** - 批量删除实验室
   - 请求体：ids（实验室ID列表）
   - 权限：管理员

7. **PUT /api/v1/laboratory/{id}/status** - 更新实验室状态
   - 请求体：status（0-不可用，1-可用，2-维护中）
   - 权限：管理员

8. **GET /api/v1/laboratory/{id}/equipment** - 获取实验室设备列表
   - 支持分页和状态筛选
   - 权限：管理员/教师

### 设备管理模块（EquipmentController）
1. **GET /api/v1/equipment** - 获取设备列表
   - 支持分页（page, size）
   - 支持筛选（name, model, specification, assetCode, supplier, statusCode, laboratoryId, purchaseDateStart, purchaseDateEnd）
   - 支持排序（sortBy, sortOrder）
   - 权限：管理员/教师/学生

2. **GET /api/v1/equipment/{id}** - 获取设备详情
   - 包含状态信息和实验室信息
   - 权限：管理员/教师/学生

3. **POST /api/v1/equipment** - 创建设备
   - 请求体：name, model, specification, assetCode, unitPrice, quantity, supplier, purchaseDate, warrantyPeriod, statusId, laboratoryId, description
   - 权限：管理员

4. **PUT /api/v1/equipment/{id}** - 更新设备
   - 请求体：所有字段可选
   - 权限：管理员

5. **DELETE /api/v1/equipment/{id}** - 删除设备
   - 权限：管理员

6. **DELETE /api/v1/equipment/batch** - 批量删除设备
   - 请求体：ids（设备ID列表）
   - 权限：管理员

7. **PUT /api/v1/equipment/{id}/status** - 更新设备状态
   - 请求体：statusId
   - 权限：管理员/教师

8. **GET /api/v1/equipment/status** - 获取设备状态列表
   - 权限：管理员/教师/学生

## 代码结构

```
backend/src/main/java/org/cong/backend/
├── laboratory/                          # 实验室管理模块
│   ├── controller/
│   │   └── LaboratoryController.java   # 实验室管理控制器
│   ├── service/
│   │   └── LaboratoryService.java      # 实验室业务逻辑
│   ├── repository/
│   │   └── LaboratoryRepository.java  # 实验室数据访问
│   ├── entity/
│   │   └── Laboratory.java             # 实验室实体
│   └── dto/                            # 数据传输对象
│       ├── CreateLaboratoryRequest.java
│       ├── UpdateLaboratoryRequest.java
│       ├── LaboratoryListResponse.java
│       ├── LaboratoryDetailResponse.java
│       └── UpdateStatusRequest.java
├── equipment/                          # 设备管理模块
│   ├── controller/
│   │   └── EquipmentController.java   # 设备管理控制器
│   ├── service/
│   │   ├── EquipmentService.java       # 设备业务逻辑
│   │   └── EquipmentStatusService.java # 设备状态业务逻辑
│   ├── repository/
│   │   ├── EquipmentRepository.java    # 设备数据访问
│   │   └── EquipmentStatusRepository.java # 设备状态数据访问
│   ├── entity/
│   │   ├── Equipment.java             # 设备实体
│   │   └── EquipmentStatus.java       # 设备状态实体
│   └── dto/                            # 数据传输对象
│       ├── CreateEquipmentRequest.java
│       ├── UpdateEquipmentRequest.java
│       ├── EquipmentListResponse.java
│       ├── EquipmentDetailResponse.java
│       ├── UpdateEquipmentStatusRequest.java
│       └── EquipmentStatusResponse.java
```

```
frontend/src/
├── api/
│   ├── laboratory.ts                   # 实验室API接口
│   └── equipment.ts                    # 设备API接口
├── views/
│   ├── HomeView.vue                    # 主页面（包含菜单）
│   ├── LaboratoryListView.vue         # 实验室列表页
│   └── EquipmentListView.vue           # 设备列表页
└── router/
    └── index.ts                        # 路由配置
```

## 权限控制

### 实验室管理
- **查看列表/详情**：管理员、教师、学生（@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")）
- **创建/更新/删除**：仅管理员（@PreAuthorize("hasRole('admin')")）
- **查看设备列表**：管理员、教师（@PreAuthorize("hasAnyRole('admin', 'teacher')")）

### 设备管理
- **查看列表/详情**：管理员、教师、学生（@PreAuthorize("hasAnyRole('admin', 'teacher', 'student')")）
- **创建/更新/删除**：仅管理员（@PreAuthorize("hasRole('admin')")）
- **更新状态**：管理员、教师（@PreAuthorize("hasAnyRole('admin', 'teacher')")）

## 开发过程中遇到的问题及解决方案
### 问题1：浮点类型精度定义错误
**现象**：启动后端时遇到错误：`java.lang.IllegalArgumentException: scale has no meaning for SQL floating point types`

**原因**：
- 在`Laboratory`实体中，`area`字段使用了`@Column(precision = 10, scale = 2)`
- 在`Equipment`实体中，`unitPrice`字段使用了`@Column(precision = 10, scale = 2)`
- 当使用`precision`和`scale`时，JPA会尝试将Java的`Double`类型映射为数据库的`DECIMAL`类型
- 但如果数据库表已经定义为`DOUBLE`或`FLOAT`类型，或者JPA自动推断为浮点类型时，就会出现此错误

**解决方案**：
- 将`@Column(precision = 10, scale = 2)`改为`@Column(columnDefinition = "DECIMAL(10,2)")`
- 明确指定使用`DECIMAL`类型而不是`DOUBLE`或`FLOAT`类型
- `DECIMAL`类型支持精度和小数位数，适合存储金额、面积等需要精确计算的数值
- 修改位置：
  - `Laboratory.java`：`area`字段
  - `Equipment.java`：`unitPrice`字段

## 待完成的工作

### 1. 设备详情页
- 当前只有列表页，详情查看功能标记为TODO
- 需要创建EquipmentDetailView.vue页面
- 显示设备的完整信息和关联数据

### 2. 实验室详情页
- 当前只有列表页，详情查看功能标记为TODO
- 需要创建LaboratoryDetailView.vue页面
- 显示实验室的完整信息和设备列表

### 3. 数据验证增强
- 当前只做了基本的必填验证
- 需要添加更详细的业务规则验证
- 例如：实验室编号唯一性、资产编号唯一性等

### 4. 演示数据准备
- 需要插入3-5个实验室数据
- 需要插入10-20台设备数据
- 确保设备状态表有初始数据（pending, instored, inuse, repairing, scrapped）

### 5. 性能优化
- 设备列表按状态代码筛选的性能优化
- 考虑添加数据库索引
- 考虑使用JOIN查询替代多次查询

## 测试验证

### 后端接口测试（Swagger）
- ✅ GET /api/v1/laboratory - 实验室列表查询
- ✅ GET /api/v1/laboratory/{id} - 实验室详情查询
- ✅ POST /api/v1/laboratory - 创建实验室
- ✅ PUT /api/v1/laboratory/{id} - 更新实验室
- ✅ DELETE /api/v1/laboratory/{id} - 删除实验室
- ✅ PUT /api/v1/laboratory/{id}/status - 更新实验室状态
- ✅ GET /api/v1/laboratory/{id}/equipment - 获取实验室设备列表
- ✅ GET /api/v1/equipment - 设备列表查询
- ✅ GET /api/v1/equipment/{id} - 设备详情查询
- ✅ POST /api/v1/equipment - 创建设备
- ✅ PUT /api/v1/equipment/{id} - 更新设备
- ✅ DELETE /api/v1/equipment/{id} - 删除设备
- ✅ PUT /api/v1/equipment/{id}/status - 更新设备状态
- ✅ GET /api/v1/equipment/status - 获取设备状态列表

### 前端功能测试
- ✅ 登录后显示菜单（实验室管理、设备管理）
- ✅ 实验室列表页显示数据
- ✅ 实验室新增/编辑功能
- ✅ 实验室删除功能
- ✅ 设备列表页显示数据
- ✅ 设备新增/编辑功能（必须选择实验室）
- ✅ 设备删除功能
- ✅ 设备筛选功能（按实验室、状态筛选）

### 测试工具
- Swagger UI：`http://localhost:8080/swagger-ui/index.html`
- 前端开发服务器：`http://localhost:5173`

### 测试脚本
- `backend\src\test\java\org\cong\backend`

## 完整流程验证

### 测试场景：登录 → 查看实验室列表 → 新增实验室 → 新增设备 → 查看设备列表

1. **登录系统**
   - 使用管理员账号登录（admin / admin123）
   - 成功跳转到首页，显示菜单

2. **查看实验室列表**
   - 点击"实验室管理"菜单
   - 显示实验室列表（初始为空）

3. **新增实验室**
   - 点击"新增实验室"按钮
   - 填写实验室信息（名称、编号、位置等）
   - 提交成功，列表刷新显示新数据

4. **新增设备**
   - 点击"设备管理"菜单
   - 点击"新增设备"按钮
   - 填写设备信息（必须选择实验室）
   - 提交成功，列表刷新显示新数据

5. **查看设备列表**
   - 设备列表正确显示
   - 可以按实验室筛选
   - 可以按状态筛选

## 总结

本次开发完成了实验室管理与设备基础模块的核心功能，包括：

### 后端功能
- ✅ 实验室管理（CRUD + 状态更新 + 设备列表查询）
- ✅ 设备管理（CRUD + 状态更新 + 状态列表查询）
- ✅ 权限控制（基于角色的访问控制）
- ✅ 数据验证（必填字段、唯一性校验）
- ✅ 关联查询（设备关联实验室、状态信息）

### 前端功能
- ✅ 实验室列表页（列表 + 搜索 + 新增/编辑弹窗）
- ✅ 设备列表页（列表 + 搜索 + 新增/编辑弹窗 + 实验室筛选）
- ✅ 菜单导航（登录后显示功能入口）
- ✅ 路由配置（嵌套路由，默认跳转）

### 关键特性
- **设备必须关联到实验室**：创建设备时laboratoryId为必填项，不能使用自由文本位置
- **权限控制**：管理员可CRUD，教师/学生只读（部分功能教师可操作）
- **快速跑通**：前后端都能快速看到成果，登录后即可使用

### 下一步工作
1. 准备演示数据（3-5个实验室 + 10-20台设备）
2. 完善详情页功能
3. 优化查询性能
4. 添加更多业务验证规则

