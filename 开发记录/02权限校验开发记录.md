# 权限校验模块开发记录

## 开发目标
完成用户与角色管理模块的权限校验功能，实现基于 Spring Security 和 JWT 的完整 RBAC 权限控制。

## 功能需求
根据 `docs/功能清单_规则文件.md` 的要求，实现以下功能：
- 基于角色的功能权限控制
- Spring Security 权限校验
- JWT 身份认证集成

## 技术实现

### 1. JWT 认证过滤器
创建 `JwtAuthenticationFilter.java`，实现以下功能：
- 从请求头中提取 JWT Token（支持 `Bearer {token}` 和直接 `{token}` 两种格式）
- 验证 Token 的有效性
- 从 Token 中提取用户信息和角色信息
- 设置 Spring Security 认证上下文

**关键代码：**
```java
@Component
public class JwtAuthenticationFilter extends OncePerRequestFilter {
    // 从请求头提取 Token
    // 验证 Token 并获取用户名和角色
    // 创建 Authentication 对象并设置到 SecurityContext
}
```

### 2. Spring Security 配置
创建 `SecurityConfig.java`，配置以下内容：
- 禁用 CSRF（JWT 无状态认证）
- 配置 CORS 支持
- 设置会话管理为无状态（STATELESS）
- 配置公开访问路径（登录接口、Swagger UI）
- 添加 JWT 过滤器到过滤器链
- 启用方法级权限控制（`@PreAuthorize`）

**公开访问路径：**
- `/api/v1/auth/login` - 登录接口
- `/swagger-ui/**` - Swagger UI
- `/v3/api-docs/**` - API 文档
- `/error` - 错误页面

**其他所有接口都需要认证。**

### 3. 权限工具类和服务
创建 `SecurityUtils.java` 工具类：
- `getCurrentUsername()` - 获取当前登录用户名
- `getCurrentUserRole()` - 获取当前用户角色代码
- `isAdmin()` / `isTeacher()` / `isStudent()` - 检查用户角色
- `hasRole(String roleCode)` - 检查是否有指定角色

创建 `PermissionService.java` 服务：
- `isCurrentUser(Long userId)` - 检查是否是当前用户
- 用于在 `@PreAuthorize` 注解中进行权限校验

### 4. 全局异常处理
创建 `GlobalExceptionHandler.java`，处理以下异常：
- `AccessDeniedException` - 返回 403 无权限
- `AuthenticationCredentialsNotFoundException` - 返回 401 未授权

### 5. Controller 权限注解
在所有 Controller 方法上添加 `@PreAuthorize` 注解：

**UserController：**
- `GET /api/v1/users` - `@PreAuthorize("hasRole('admin')")`
- `GET /api/v1/users/{id}` - `@PreAuthorize("hasRole('admin') or @permissionService.isCurrentUser(#id)")`
- `POST /api/v1/users` - `@PreAuthorize("hasRole('admin')")`
- `PUT /api/v1/users/{id}` - `@PreAuthorize("hasRole('admin')")`
- `DELETE /api/v1/users/{id}` - `@PreAuthorize("hasRole('admin')")`
- `PUT /api/v1/users/{id}/password` - `@PreAuthorize("hasRole('admin') or @permissionService.isCurrentUser(#id)")`
- `DELETE /api/v1/users/batch` - `@PreAuthorize("hasRole('admin')")`

**RoleController：**
- `GET /api/v1/roles` - `@PreAuthorize("hasRole('admin') or hasRole('teacher')")`

**AuthController：**
- `GET /api/v1/auth/me` - 使用 Spring Security 上下文获取当前用户
- `POST /api/v1/auth/logout` - 已登录用户可访问

## 新增文件

1. **backend/src/main/java/org/cong/backend/security/JwtAuthenticationFilter.java**
   - JWT 认证过滤器

2. **backend/src/main/java/org/cong/backend/config/SecurityConfig.java**
   - Spring Security 配置类

3. **backend/src/main/java/org/cong/backend/security/SecurityUtils.java**
   - 安全工具类

4. **backend/src/main/java/org/cong/backend/security/PermissionService.java**
   - 权限检查服务

5. **backend/src/main/java/org/cong/backend/common/GlobalExceptionHandler.java**
   - 全局异常处理器

## 修改文件

1. **BackendApplication.java**
   - 移除 `@SpringBootApplication(exclude = {SecurityAutoConfiguration.class})`
   - 重新启用 Spring Security 自动配置

2. **PasswordConfig.java**
   - 修改为使用 `NoOpPasswordEncoder` 支持明文密码（按开发要求）

3. **AuthController.java**
   - 移除手动 Token 解析逻辑
   - 使用 Spring Security 上下文获取当前用户信息
   - 移除 `PasswordEncoder` 依赖（使用明文密码比较）

4. **UserController.java**
   - 添加 `@PreAuthorize` 注解实现权限控制
   - 移除 `Principal` 参数，使用 `SecurityUtils` 获取当前用户
   - 移除 `UserRepository` 依赖（权限检查移至 `PermissionService`）

5. **RoleController.java**
   - 添加 `@PreAuthorize` 注解实现权限控制

## 权限控制规则

### 管理员（admin）
- 拥有所有权限
- 可以查看、创建、更新、删除所有用户
- 可以重置任何用户的密码
- 可以查看角色列表

### 教师（teacher）
- 可以查看角色列表
- 其他权限待后续模块实现

### 学生（student）
- 可以查看和修改自己的信息
- 可以修改自己的密码
- 其他权限待后续模块实现

## 权限控制实现方式

使用 Spring Security 的 `@PreAuthorize` 注解，结合 SpEL 表达式：

```java
// 检查角色
@PreAuthorize("hasRole('admin')")
@PreAuthorize("hasRole('admin') or hasRole('teacher')")

// 检查是否是当前用户
@PreAuthorize("hasRole('admin') or @permissionService.isCurrentUser(#id)")
```

## 测试说明

### 测试步骤
1. 使用登录接口获取 JWT Token：`POST /api/v1/auth/login`
2. 在请求头中携带 Token：`Authorization: Bearer {token}`
3. 测试各个接口的权限控制

### Swagger UI 测试
1. 访问 `http://localhost:8080/swagger-ui/index.html`
2. 点击右上角的 "Authorize" 按钮
3. 输入 JWT Token（不需要 "Bearer" 前缀）
4. 点击 "Authorize" 确认
5. 测试各个接口

### 预期结果
- 未登录或 Token 无效：返回 401 未授权
- 权限不足：返回 403 无权限
- 权限足够：正常返回业务数据

## 总结

本次开发完成了用户与角色管理模块的权限校验功能：

1. ✅ 重新启用 Spring Security，配置 JWT 过滤链
2. ✅ 实现基于角色的访问控制（RBAC）
3. ✅ 在所有 Controller 方法上添加权限校验
4. ✅ 创建权限工具类和服务，简化权限检查逻辑
5. ✅ 创建全局异常处理器，提供友好的错误信息
6. ✅ 优化认证逻辑，使用 Spring Security 标准方式

所有接口已实现完整的权限控制，符合功能清单中"基于角色的功能权限控制"和"Spring Security 权限校验"的要求。

## 后续工作

1. 密码加密：当前使用明文密码，后续需要改为 BCrypt 加密
2. 日志记录：添加操作日志和审计日志
3. 异常处理：创建自定义异常类，提供更详细的错误信息
4. 其他模块的权限控制：设备管理、实验室管理等模块的权限控制

