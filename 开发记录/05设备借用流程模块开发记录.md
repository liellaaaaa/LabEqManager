# 设备借用流程模块开发记录（equipment_borrow）

## 开发目标

实现功能清单中“设备全生命周期管理”的主干流程之一：**设备借用流程（借用-审批-借出-归还-逾期）**，形成一个基于真实设备数据的可用闭环。

参考文档：

- 接口文档：`docs/api-docs/borrow.md`
- 数据库结构：`lab_equipment_manager.sql` 中的 `equipment_borrow` 表

## 数据库设计（回顾）

### 设备借用记录表 `equipment_borrow`

- **核心字段**
  - `id`：借用记录 ID
  - `equipment_id`：设备 ID（外键，关联 `equipment.id`）
  - `user_id`：借用用户 ID（外键，关联 `user.id`）
  - `borrow_date`：借用日期
  - `plan_return_date`：计划归还日期
  - `actual_return_date`：实际归还日期
  - `purpose`：借用用途
  - `quantity`：借用数量
  - `status`：状态（0-待审批，1-已通过，2-已拒绝，3-已借出，4-已归还，5-已逾期）
  - `approver_id`：审批人 ID
  - `approve_time`：审批时间
  - `approve_remark`：审批备注
  - `create_time` / `update_time`：创建 / 更新时间

## 后端实现

### 1. 实体 & 仓储

- **实体**
  - `backend/src/main/java/org/cong/backend/borrow/entity/EquipmentBorrow.java`
    - 与 `equipment_borrow` 表一一对应，使用 JPA 映射 + `@PrePersist` / `@PreUpdate` 自动维护时间字段。

- **仓储**
  - `backend/src/main/java/org/cong/backend/borrow/repository/EquipmentBorrowRepository.java`
    - `int sumBorrowedQuantity(Long equipmentId)`：统计某设备当前“已借出 + 已逾期”的总借用数量，用于计算可用数量。
    - `List<EquipmentBorrow> findByStatusAndPlanReturnDateBefore(Integer status, LocalDateTime time)`：查找“已借出且计划归还时间已过”的记录，用于标记逾期。

### 2. DTO & 状态常量

- `BorrowStatus`：封装状态值及中文名称映射（0-5），与数据库枚举语义保持一致。
- 请求 DTO：
  - `CreateBorrowRequest`：提交借用申请
  - `ApproveBorrowRequest`：审批借用申请（仅管理员）
  - `ConfirmBorrowRequest`：确认设备借出（仅管理员）
  - `ReturnBorrowRequest`：归还设备（管理员或借用人）
- 响应 DTO：
  - `BorrowListResponse`：借用记录列表项（包含设备名、借用人姓名、审批人姓名、状态名称等）
  - `BorrowDetailResponse`：借用记录详情
  - `MarkOverdueResponse`：标记逾期返回的统计信息
  - `AvailableQuantityResponse`：设备当前总量 / 已借出量 / 可用量

### 3. Service 业务逻辑

实现类：`backend/src/main/java/org/cong/backend/borrow/service/EquipmentBorrowService.java`

- **依赖**
  - `EquipmentBorrowRepository`：借用记录持久化
  - `EquipmentRepository` / `EquipmentStatusRepository`：设备与设备状态信息
  - `UserRepository`：借用人 / 审批人信息
  - `SecurityUtils`：获取当前登录用户及角色

- **核心方法**

1. **getBorrowList**：借用记录列表查询
   - 支持分页、按设备 / 用户 /状态 / 借用日期范围过滤、排序。
   - 权限规则：
     - 管理员：可通过 `userId` 参数查看任意用户记录。
     - 教师 / 学生：强制仅能查看自己的借用记录（忽略外部传入的 `userId`）。

2. **getBorrowDetail**：借用记录详情
   - 管理员可查看全部；非管理员只能查看自己的记录，否则抛出 `403 无权限查看该借用记录详情`。

3. **createBorrow**：提交借用申请
   - 通过 `SecurityUtils` + `UserRepository` 解析当前用户，未登录返回 401。
   - 校验：
     - 设备存在性（404）
     - 计划归还日期不能早于借用日期（400）
     - 设备当前状态可借（基于 `equipment_status.code`，目前允许 `instored` / `inuse`）
     - 借用数量不能超过设备可用数量（400）
   - 创建一条状态为“0-待审批”的借用记录，并返回详情。

4. **approveBorrow**：审批借用申请（仅管理员）
   - 仅允许从“待审批（0）”进入“已通过（1）/已拒绝（2）”，否则抛出“该借用记录已审批过，无法重复审批”。
   - 记录审批人 ID、审批时间、审批备注。

5. **confirmBorrow**：确认设备借出（仅管理员）
   - 仅允许在状态“1-已通过”时调用，否则抛出“该借用记录状态不符合要求，无法确认借出”。
   - 调用前再次计算设备可用数量，避免在审批通过后又有其他借用改变库存。
   - 设置实际借出时间（可传入或默认当前时间），将状态更新为“3-已借出”。

6. **returnBorrow**：归还设备（管理员或借用人）
   - 权限：管理员或本条记录的借用人，其他用户返回 403 “无权限归还该设备”。
   - 仅允许在“3-已借出 / 5-已逾期”状态下归还，否则抛出“该借用记录状态不符合要求，无法归还”。
   - 更新实际归还时间、状态改为“4-已归还”；归还备注会合并写入 `approve_remark` 字段中，方便统一查看。

7. **markOverdue**：标记逾期（仅管理员调用）
   - 查询所有“已借出（3）且计划归还时间早于当前时间”的记录，将其状态批量更新为“5-已逾期”。
   - 返回成功标记的记录数量 `overdueCount`。

8. **getAvailableQuantity / getAvailableQuantityInternal**：计算设备可用数量
   - `totalQuantity = equipment.quantity`
   - `borrowedQuantity = sumBorrowedQuantity(equipmentId)`（仅统计状态为“已借出/已逾期”的记录）
   - `availableQuantity = max(0, totalQuantity - borrowedQuantity)`

### 4. Controller 接口

控制器：`backend/src/main/java/org/cong/backend/borrow/controller/EquipmentBorrowController.java`

统一走 `ApiResponse<T>` 返回结构，并使用 `@SecurityRequirement(name = "bearerAuth")` + `@PreAuthorize` 控制权限。

实现的接口与 `docs/api-docs/borrow.md` 对齐：

1. **GET /api/v1/borrow**
   - 借用记录列表查询（分页 + 筛选 + 排序）。
   - 权限：管理员 / 教师 / 学生。

2. **GET /api/v1/borrow/{id}**
   - 借用记录详情。
   - 权限：管理员 / 教师 / 学生；非管理员只能查看自己的记录。

3. **POST /api/v1/borrow**
   - 提交借用申请。
   - 权限：管理员 / 教师 / 学生。

4. **PUT /api/v1/borrow/{id}/approve**
   - 审批借用申请。
   - 权限：仅管理员。

5. **PUT /api/v1/borrow/{id}/borrow**
   - 确认设备借出。
   - 权限：仅管理员。

6. **PUT /api/v1/borrow/{id}/return**
   - 归还设备。
   - 权限：管理员 + 借用人。

7. **PUT /api/v1/borrow/mark-overdue**
   - 标记逾期借用记录。
   - 权限：仅管理员。

8. **GET /api/v1/borrow/available-quantity/{equipmentId}**
   - 获取设备当前可用数量（总量 / 已借出 / 可用）。
   - 权限：管理员 / 教师 / 学生。

## 测试记录（后端）

测试类：`backend/src/test/java/org/cong/backend/borrow/EquipmentBorrowControllerTest.java`

- **测试环境**
  - `@SpringBootTest` + `@AutoConfigureMockMvc`
  - 使用真实 MySQL 库（与其他模块一致），通过随机资产编号 / 测试实验室 / 测试用户避免与真实数据冲突。
  - 使用 `@WithMockUser` + `user().roles(...)` 模拟不同角色（student / admin）。

- **已实现用例**
  1. **申请 → 审批 → 借出 → 归还 主流程闭环**
     - 学生提交借用申请，管理员审批通过并确认借出，学生完成归还。
     - 断言：
       - 状态流转：0（待审批）→ 1（已通过）→ 3（已借出）→ 4（已归还）。
       - 可用数量计算：总数 2、借出 1、可用 1。
       - 归还后 `actualReturnDate` 字段有值。
  2. **管理员标记逾期：已借出且超过计划归还日期 → 已逾期**
     - 构造一条已经超过计划归还日期的“已借出”记录，调用 `mark-overdue` 将其状态更新为“5-已逾期”。
     - 断言：
       - `overdueCount` 为数字（>=1）。
       - 再查询该记录详情，状态为“5-已逾期”。

- **后续测试改进方向**
  - 已在 `测试记录/05问题汇总.md` 中记录：包括数量超限、非法设备 ID、权限校验、时间边界、并发/冲突等更多场景。

## 后续工作建议

- **增加更多测试用例**：覆盖 05 问题汇总中列出的异常 / 权限 / 边界场景，提升借用流程的稳定性和回归信心。
- **与前端联调**：基于现有接口，前端可快速实现“借用申请表单 + 我的借用列表 + 审批列表 + 逾期标记入口”，形成设备生命周期的可用闭环。


