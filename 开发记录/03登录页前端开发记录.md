# 登录页前端开发记录

## 开发目标
实现用户与角色管理模块的前端登录页面，对接后端认证接口，完成用户登录功能。

## 功能需求
根据 `docs/api-docs/auth.md` 的要求，实现以下功能：
- 用户登录页面（美观的UI界面）
- 表单验证（用户名、密码必填及长度校验）
- 登录接口调用（POST /api/v1/auth/login）
- JWT Token 存储和管理
- 登录成功后自动跳转
- 路由守卫（未登录自动跳转登录页）

## 技术栈

### 前端框架
- Vue 3.5.26（Composition API）
- TypeScript 5.9.3
- Vite 7.3.0

### UI 组件库
- Element Plus 2.13.1
- @element-plus/icons-vue（图标库）

### 状态管理
- Pinia 3.0.4

### 路由管理
- Vue Router 4.6.4

### HTTP 请求
- Axios（最新版本）

## 实现的文件

### 1. API 工具类
**文件路径：** `frontend/src/utils/request.ts`

**功能说明：**
- 封装 axios 实例，配置基础 URL 和超时时间
- 请求拦截器：自动从 localStorage 获取 token 并添加到请求头
- 响应拦截器：
  - 统一处理 API 响应格式（`ApiResponse<T>`）
  - 自动处理错误信息（显示 Element Plus 消息提示）
  - 401 未授权时自动清除 token 并跳转登录页
  - 网络错误处理

**关键代码：**
```typescript
// 请求拦截器 - 自动添加 token
service.interceptors.request.use((config) => {
  const token = localStorage.getItem('token')
  if (token) {
    config.headers.Authorization = `Bearer ${token}`
  }
  return config
})

// 响应拦截器 - 统一错误处理
service.interceptors.response.use(
  (response: AxiosResponse<ApiResponse<any>>) => {
    const res = response.data
    if (res.code !== 200) {
      ElMessage.error(res.message || '请求失败')
      if (res.code === 401) {
        // 401 自动跳转登录
        localStorage.removeItem('token')
        localStorage.removeItem('userInfo')
        if (window.location.pathname !== '/login') {
          window.location.href = '/login'
        }
      }
      return Promise.reject(new Error(res.message || '请求失败'))
    }
    return { ...response, data: res } as AxiosResponse<ApiResponse<any>>
  }
)
```

### 2. 认证 API
**文件路径：** `frontend/src/api/auth.ts`

**功能说明：**
- 定义登录、注销、获取当前用户信息的 API 接口
- 定义 TypeScript 类型（LoginRequest、UserInfo、LoginResponse）
- 封装 API 调用方法

**接口列表：**
- `login(data: LoginRequest)` - 登录接口
- `logout()` - 注销接口
- `getCurrentUser()` - 获取当前用户信息

### 3. 用户状态管理
**文件路径：** `frontend/src/stores/user.ts`

**功能说明：**
- 使用 Pinia 管理用户登录状态
- 存储 token 和用户信息（响应式）
- 提供登录、注销、获取用户信息等方法
- 自动同步 localStorage（持久化存储）
- 提供角色检查方法（isAdmin、isTeacher、isStudent）

**主要方法：**
```typescript
- login(loginData: LoginRequest) - 登录
- logout() - 注销
- fetchUserInfo() - 获取当前用户信息
- isLoggedIn() - 检查是否已登录
- isAdmin() / isTeacher() / isStudent() - 角色检查
```

### 4. 登录页面组件
**文件路径：** `frontend/src/views/LoginView.vue`

**功能说明：**
- 美观的登录界面（渐变背景、卡片式布局）
- 用户名和密码输入框（带图标、可清除）
- 表单验证（必填、长度校验）
- 登录按钮（加载状态）
- 支持 Enter 键提交
- 登录成功后自动跳转首页

### 5. 路由配置
**文件路径：** `frontend/src/router/index.ts`

**功能说明：**
- 配置登录页路由（`/login`）
- 配置路由守卫：
  - 需要认证的路由：未登录自动跳转登录页
  - 已登录用户访问登录页：自动跳转首页
  - 支持 redirect 参数（登录后跳转到原目标页面）

**路由守卫逻辑：**
```typescript
router.beforeEach((to, from, next) => {
  const userStore = useUserStore()
  if (to.meta.requiresAuth) {
    if (userStore.isLoggedIn()) {
      next()
    } else {
      next({ name: 'login', query: { redirect: to.fullPath } })
    }
  } else {
    if (to.name === 'login' && userStore.isLoggedIn()) {
      next({ name: 'home' })
    } else {
      next()
    }
  }
})
```

### 6. Element Plus 配置
**文件路径：** `frontend/src/main.ts`

**功能说明：**
- 全局注册 Element Plus
- 注册所有 Element Plus 图标组件
- 引入 Element Plus 样式文件

## 代码结构

```
frontend/src/
├── api/
│   └── auth.ts                    # 认证 API 接口
├── stores/
│   └── user.ts                    # 用户状态管理（Pinia）
├── utils/
│   └── request.ts                 # Axios 封装（请求/响应拦截器）
├── views/
│   └── LoginView.vue              # 登录页面组件
├── router/
│   └── index.ts                   # 路由配置（含路由守卫）
├── main.ts                        # 应用入口（Element Plus 配置）
└── App.vue                        # 根组件（简化版）
```

## 开发过程中遇到的问题及解决方案

### 问题1：响应拦截器类型问题
**现象：** TypeScript 报错，提示响应拦截器返回类型不匹配

**原因：** Axios 的响应拦截器必须返回 `AxiosResponse` 类型，但我们需要返回 `ApiResponse<T>`

**解决方案：**
- 在响应拦截器中返回完整的 response 对象，但将 `response.data` 替换为 `ApiResponse<T>`
- 在 API 函数中从 `response.data` 提取 `ApiResponse<T>`
- 使用类型断言确保类型安全

### 问题2：用户状态初始化问题
**现象：** `ref` 初始化时使用函数导致类型错误

**原因：** `ref` 的初始化参数应该是值，而不是函数

**解决方案：**
```typescript
// 错误写法
const userInfo = ref<UserInfo | null>(() => {
  const stored = localStorage.getItem('userInfo')
  return stored ? JSON.parse(stored) : null
})

// 正确写法
const stored = localStorage.getItem('userInfo')
const userInfo = ref<UserInfo | null>(stored ? (JSON.parse(stored) as UserInfo) : null)
```

### 问题3：API 返回类型处理
**现象：** API 函数返回类型与 store 中使用不一致

**原因：** 响应拦截器返回的是 `AxiosResponse<ApiResponse<T>>`，需要提取 `data` 字段

**解决方案：**
- API 函数返回 `Promise<ApiResponse<T>>`
- Store 中通过 `response.data` 访问实际数据
- 统一处理 `ApiResponse` 格式（code、message、data）

### 问题4：Element Plus 图标未注册
**现象：** 登录页使用图标组件时报错

**原因：** Element Plus 图标需要单独安装和注册

**解决方案：**
1. 安装 `@element-plus/icons-vue` 包
2. 在 `main.ts` 中批量注册所有图标组件：
```typescript
import * as ElementPlusIconsVue from '@element-plus/icons-vue'
for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
  app.component(key, component)
}
```

## 测试验证

### 测试步骤
1. 启动后端服务（确保运行在 `http://localhost:8080`）
2. 启动前端服务：`npm run dev`
3. 访问登录页：`http://localhost:5173/login`
4. 测试登录功能：
   - 使用默认管理员账号：`admin` / `admin123`
   - 测试表单验证（空值、长度限制）
   - 测试错误提示（用户名或密码错误）
   - 测试登录成功后的跳转

### 测试结果
- ✅ 登录页面正常显示（美观的UI）
- ✅ 表单验证正常工作
- ✅ 登录接口调用成功
- ✅ Token 正确存储到 localStorage
- ✅ 用户信息正确存储
- ✅ 登录成功后自动跳转首页
- ✅ 路由守卫正常工作（未登录自动跳转登录页）
- ✅ 错误提示正常显示（Element Plus 消息提示）

### 测试账号
根据后端开发记录，默认管理员账号：
- 用户名：`admin`
- 密码：`admin123`

## 接口对接说明

### 登录接口
- **URL：** `POST /api/v1/auth/login`
- **请求体：**
  ```json
  {
    "username": "admin",
    "password": "admin123"
  }
  ```
- **响应格式：**
  ```json
  {
    "code": 200,
    "message": "登录成功",
    "data": {
      "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
      "userInfo": {
        "id": 1,
        "username": "admin",
        "name": "系统管理员",
        "email": "admin@example.com",
        "phone": "13800138000",
        "department": "信息中心",
        "roleCode": "admin",
        "status": 1
      }
    }
  }
  ```

### Token 存储
- Token 存储在 `localStorage` 中，键名为 `token`
- 用户信息存储在 `localStorage` 中，键名为 `userInfo`
- 请求拦截器自动从 `localStorage` 读取 token 并添加到请求头：`Authorization: Bearer {token}`

## 总结

本次开发完成了登录页面的前端实现，包括：

1. ✅ **API 工具类**：封装 axios，实现请求/响应拦截器，统一错误处理
2. ✅ **认证 API**：封装登录、注销、获取用户信息接口
3. ✅ **用户状态管理**：使用 Pinia 管理用户登录状态，支持持久化存储
4. ✅ **登录页面**：美观的 UI 界面，完整的表单验证和错误处理
5. ✅ **路由守卫**：实现未登录自动跳转登录页的功能
6. ✅ **Element Plus 集成**：全局配置 Element Plus 和图标库

所有功能已通过测试，登录功能正常工作。前端已准备好对接后续的功能模块。

## 后续工作

1. **首页开发**：登录成功后跳转的首页（根据用户角色显示不同内容）
2. **导航栏开发**：顶部导航栏（用户信息、注销按钮等）
3. **其他页面**：用户管理、设备管理等页面的前端实现
4. **Token 刷新**：实现 token 过期自动刷新机制（可选）

