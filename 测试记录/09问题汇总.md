# AI 智能助手模块测试问题汇总（AiAssistantControllerTest）

## 测试时间
2026-01-26

## 主要问题列表与修复记录

### 1. DashScope SDK 返回类型不匹配 / 类找不到

**问题描述：**
- 测试用例：`AiAssistantControllerTest` 整体初始化阶段
- 现象：
  - 早期实现中直接使用 `QwenResult` / `GenerationResult` 等类型，但与当前版本 `dashscope-sdk-java 2.8.3` 的实际返回类型不一致；
  - 编译期出现 “找不到符号 QwenResult / GenerationResult” 等错误。

**原因分析：**
- 参考的示例代码与当前 SDK 版本存在差异；
- 项目中未引入对应的 `models` 类型定义或包名已调整。

**解决方案：**
- 不再强依赖具体的返回类型类名，改为：
  - 使用 `var result = gen.call(param)` 让编译器推断类型；
  - 通过 **反射** 访问 `getOutput() / getChoices() / getMessage() / getContent()` 或对应字段，兼容不同 SDK 版本的结构；
  - 在解析失败时，优雅降级：返回“AI 服务暂时不可用，请稍后重试”的友好提示。

**修复状态：** ✅ 已修复（测试通过）

---

### 2. 停用词集合重复导致 `IllegalArgumentException: duplicate element`

**问题描述：**
- 测试用例：
  - `API 调用测试：知识库未匹配的问题`
  - `日志记录测试：验证日志按日期保存`
  - `单轮对话测试：不维护上下文`
- 现象：
  - 多个用例在调用 `AiAssistantService.matchKnowledgeBase()` 过程中抛出：
    - `java.lang.IllegalArgumentException: duplicate element: 什么`

**原因分析：**
- 在 `extractKeywords` 方法中使用了 `Set.of(...)` 定义停用词集合；
- 停用词列表中包含重复的 `"什么"`，`Set.of` 不允许重复元素，导致运行时抛出异常。

**解决方案：**
- 将停用词集合改为使用：
  - `new HashSet<>(Arrays.asList(...))` 构造，自动去重；
  - 同时适当扩充停用词列表（“需要”“步骤”“流程”等），提高关键词提取质量。

**修复状态：** ✅ 已修复（测试通过）

---

### 3. `ai_chat_log` 表不存在 / 手动建表 SQL 语法错误

**问题描述：**
- 测试用例：`AiAssistantControllerTest` 中多条（所有用例在 `@BeforeEach` 前失败）
- 现象：
  - 早期版本中：
    - Hibernate 未自动创建 `ai_chat_log` 表，插入日志时报 `Table 'lab_equipment_manager.ai_chat_log' doesn't exist`；
  - 后续尝试用 `@Sql(statements = "CREATE TABLE IF NOT EXISTS ai_chat_log (...)")` 手动建表时：
    - 由于多行 SQL / 换行与 HTML 报告中的 `<br/>` 混用，导致 MySQL 解析为非法语句：
    - `SQLSyntaxErrorException: ... near '' at line 1`。

**原因分析：**
- 测试环境使用真实 MySQL，`spring.jpa.hibernate.ddl-auto=none`，不会自动建表；
-,@Sql 的多行文本在 IDEA 报告中带 `<br/>` 展示，容易与实际 SQL 混淆，维护成本高。

**解决方案：**
- 放弃在测试中手写 DDL，改为：
  - 移除 `@Sql`；
  - 在 `@SpringBootTest` 中针对测试类单独配置：
    - `@SpringBootTest(properties = { "spring.jpa.hibernate.ddl-auto=update" })`
  - 由 Hibernate 根据实体 `AiChatLog` 自动创建表结构；
  - 避免与生产环境的 `ddl-auto=none` 冲突（仅限测试类生效）。

**修复状态：** ✅ 已修复（测试通过）

---

### 4. 未登录权限期望码不一致（401 vs 403）

**问题描述：**
- 测试用例：`权限测试：未登录用户`
- 现象：
  - 测试期望返回 401；
  - 实际返回 403，消息为 “Access is denied”。

**原因分析：**
- 当前安全配置：
  - 请求通过了过滤器链，但在 `@PreAuthorize("hasAnyRole(...)")` 处被拒绝；
  - Spring Security 默认对这种情况返回 **403 Forbidden**，而不是 401。

**解决方案：**
- 将测试断言从 `isUnauthorized()` 调整为 `isForbidden()`；
- 并在测试注释中说明：这是由于方法级权限校验导致的 403，而非认证失败的 401。

**修复状态：** ✅ 已修复

---

### 5. 知识库匹配断言过于脆弱（整串 JSON `contains`）

**问题描述：**
- 测试用例：`知识库匹配测试：完全匹配 - 如何借用设备`
- 现象：
  - 早期版本使用：
    - 将整个响应 `response` 转成字符串，再用 `assertTrue(response.contains("设备借用流程"))`；
  - 在部分运行环境下可能因为空格/换行/编码差异导致断言不稳定。

**解决方案：**
- 改用 JSONPath 直接断言字段内容：
  - `andExpect(jsonPath("$.data.answer").value(containsString("设备借用流程")))`
  - 保留 `source == "knowledge"` 和日志落库校验。

**修复状态：** ✅ 已修复

